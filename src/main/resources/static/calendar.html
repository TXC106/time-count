<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å†è§†å›¾ - å·¥æ—¶è®¡ç®—ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .calendar-day {
            min-height: 120px;
            transition: all 0.3s ease;
        }
        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .loading-overlay {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
        .spinner {
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8 fade-in">
            <h1 class="text-5xl font-bold text-indigo-900 mb-4">
                ğŸ“… è€ƒå‹¤æ—¥å†
            </h1>
            <p class="text-gray-600 text-lg mb-6">
                å¯è§†åŒ–è€ƒå‹¤è®°å½• Â· èŠ‚å‡æ—¥æ ‡è®° Â· è¯·å‡ç»Ÿè®¡
            </p>
            <div class="flex justify-center gap-4">
                <a href="/" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                    ğŸ“Š ç»Ÿè®¡é¢æ¿
                </a>
                <a href="/calendar.html" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                    ğŸ“… æ—¥å†è§†å›¾
                </a>
            </div>
        </header>

        <!-- Month Selector -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 fade-in">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <button onclick="previousMonth()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors font-semibold">
                        â† ä¸Šæœˆ
                    </button>
                    <input 
                        type="month" 
                        id="calendarMonth" 
                        class="px-4 py-2 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-semibold text-lg"
                        onchange="loadCalendar()"
                    >
                    <button onclick="nextMonth()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors font-semibold">
                        ä¸‹æœˆ â†’
                    </button>
                    <button onclick="goToday()" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors font-semibold">
                        ä»Šå¤©
                    </button>
                </div>
                
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-4 h-4 bg-green-100 border-2 border-green-500 rounded"></div>
                        <span class="text-gray-700">å·¥ä½œæ—¥</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-4 h-4 bg-blue-100 border-2 border-blue-500 rounded"></div>
                        <span class="text-gray-700">è°ƒä¼‘</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-4 h-4 bg-red-100 border-2 border-red-500 rounded"></div>
                        <span class="text-gray-700">èŠ‚å‡æ—¥</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-4 h-4 bg-yellow-100 border-2 border-yellow-500 rounded"></div>
                        <span class="text-gray-700">è¯·å‡</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-4 h-4 bg-gray-100 border-2 border-gray-300 rounded"></div>
                        <span class="text-gray-700">å‘¨æœ«</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 loading-overlay flex items-center justify-center z-50">
            <div class="text-center">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-700 font-semibold">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- Calendar -->
        <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
            <h2 id="calendarTitle" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h2>
            
            <!-- Weekday Headers -->
            <div class="grid grid-cols-7 gap-2 mb-4">
                <div class="text-center font-bold text-gray-700 py-2">å‘¨ä¸€</div>
                <div class="text-center font-bold text-gray-700 py-2">å‘¨äºŒ</div>
                <div class="text-center font-bold text-gray-700 py-2">å‘¨ä¸‰</div>
                <div class="text-center font-bold text-gray-700 py-2">å‘¨å››</div>
                <div class="text-center font-bold text-gray-700 py-2">å‘¨äº”</div>
                <div class="text-center font-bold text-red-500 py-2">å‘¨å…­</div>
                <div class="text-center font-bold text-red-500 py-2">å‘¨æ—¥</div>
            </div>
            
            <!-- Calendar Days -->
            <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                <!-- æ—¥å†æ ¼å­å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- Statistics Summary -->
        <div id="summarySection" class="grid md:grid-cols-5 gap-4 mt-8 fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-sm text-gray-600 mb-1">æ€»å·¥æ—¶</div>
                <div id="summaryTotalHours" class="text-3xl font-bold text-blue-600">0</div>
                <div class="text-sm text-gray-500">å°æ—¶</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 relative group">
                <div class="text-sm text-gray-600 mb-1 flex items-center gap-1">
                    å‡ºå‹¤å¤©æ•°
                    <span class="text-xs text-green-500 cursor-help">â„¹ï¸</span>
                </div>
                <div id="summaryActualDays" class="text-3xl font-bold text-green-600">0</div>
                <div class="text-sm text-gray-500">å¤©</div>
                <div class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded py-2 px-3 bottom-full left-1/2 transform -translate-x-1/2 mb-2 whitespace-nowrap z-10">
                    æ¨è: 21å¤© | æœ‰å·¥æ—¶: <span id="summaryAttendanceDays">0</span>å¤©
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 relative group">
                <div class="text-sm text-gray-600 mb-1 flex items-center gap-1">
                    21ç‚¹åæ‰“å¡
                    <span class="text-xs text-orange-500 cursor-help">â„¹ï¸</span>
                </div>
                <div id="summaryLateNightCount" class="text-3xl font-bold text-orange-600">0</div>
                <div class="text-sm text-gray-500">æ¬¡</div>
                <div class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded py-2 px-3 bottom-full left-1/2 transform -translate-x-1/2 mb-2 whitespace-nowrap z-10">
                    æ¨èæ¬¡æ•°: 13æ¬¡
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-sm text-gray-600 mb-1">è¯·å‡æ—¶é•¿</div>
                <div id="summaryLeaveHours" class="text-3xl font-bold text-yellow-600">0</div>
                <div class="text-sm text-gray-500">å°æ—¶</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-sm text-gray-600 mb-1">å¹³å‡å·¥æ—¶</div>
                <div id="summaryAvgHours" class="text-3xl font-bold text-purple-600">0</div>
                <div class="text-sm text-gray-500">å°æ—¶/å¤©</div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-600">
            <p>å·¥æ—¶è®¡ç®—ç³»ç»Ÿ v1.0 | Spring Boot + Apache POI</p>
        </footer>
    </div>

    <script>
        let currentMonth = new Date().toISOString().slice(0, 7);
        let dailyRecords = [];
        let statistics = null;

        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            document.getElementById('calendarMonth').value = currentMonth;
            loadCalendar();
        });

        // åŠ è½½æ—¥å†æ•°æ®
        async function loadCalendar() {
            const month = document.getElementById('calendarMonth').value;
            currentMonth = month;
            showLoading();
            
            try {
                const response = await fetch(`/api/workhours/calculate?yearMonth=${month}`);
                const data = await response.json();
                
                if (data.success) {
                    statistics = data.statistics;
                    dailyRecords = data.statistics.dailyRecords || [];
                    renderCalendar();
                    updateSummary();
                } else {
                    alert('åŠ è½½å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const [year, month] = currentMonth.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            
            // å‘¨ä¸€ä¸ºç¬¬ä¸€å¤© (1-7, 1=Monday, 7=Sunday)
            let startDayOfWeek = firstDay.getDay();
            startDayOfWeek = startDayOfWeek === 0 ? 7 : startDayOfWeek; // è½¬æ¢å‘¨æ—¥ä¸º7
            
            document.getElementById('calendarTitle').textContent = `${year}å¹´${month}æœˆ`;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // æ·»åŠ å‰ç½®ç©ºç™½å¤©
            for (let i = 1; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day bg-gray-50 rounded-lg p-3';
                grid.appendChild(emptyDay);
            }
            
            // ç”Ÿæˆæ¯ä¸€å¤©
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const record = dailyRecords.find(r => r.date === dateStr);
                
                const dayElement = createDayElement(day, dateStr, record);
                grid.appendChild(dayElement);
            }
        }

        // åˆ›å»ºå•ä¸ªæ—¥æœŸå…ƒç´ 
        function createDayElement(day, dateStr, record) {
            const div = document.createElement('div');
            div.className = 'calendar-day rounded-lg p-3 border-2 cursor-pointer';
            
            const today = new Date().toISOString().slice(0, 10);
            const isToday = dateStr === today;
            
            // ç¡®å®šèƒŒæ™¯é¢œè‰²å’Œè¾¹æ¡†
            let bgClass = 'bg-white border-gray-200';
            let dayNumClass = 'text-gray-800';
            let isMakeupWorkday = false;
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            
            if (record) {
                const isHoliday = record.holiday || record.isHoliday;
                const isWorkday = record.workday || record.isWorkday;
                const isLeave = record.leave || record.isLeave;
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒä¼‘å·¥ä½œæ—¥ï¼ˆå‘¨æœ«ä½†æ˜¯å·¥ä½œæ—¥ï¼‰
                isMakeupWorkday = isWeekend && isWorkday && !isHoliday;
                
                if (isHoliday) {
                    bgClass = 'bg-red-50 border-red-500';
                    dayNumClass = 'text-red-700';
                } else if (isLeave) {
                    bgClass = 'bg-yellow-50 border-yellow-500';
                    dayNumClass = 'text-yellow-700';
                } else if (isMakeupWorkday) {
                    // è°ƒä¼‘å·¥ä½œæ—¥æ˜¾ç¤ºä¸ºè“è‰²
                    bgClass = 'bg-blue-50 border-blue-500';
                    dayNumClass = 'text-blue-700';
                } else if (isWorkday) {
                    bgClass = 'bg-green-50 border-green-500';
                    dayNumClass = 'text-green-700';
                } else {
                    bgClass = 'bg-gray-100 border-gray-300';
                    dayNumClass = 'text-gray-500';
                }
            } else {
                // æ²¡æœ‰è®°å½•æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘¨æœ«
                if (isWeekend) {
                    bgClass = 'bg-gray-100 border-gray-300';
                    dayNumClass = 'text-gray-500';
                }
            }
            
            if (isToday) {
                div.className += ' ring-4 ring-indigo-400';
            }
            
            div.className += ' ' + bgClass;
            
            // æ—¥æœŸæ•°å­—
            const dayNum = document.createElement('div');
            dayNum.className = `text-lg font-bold mb-2 ${dayNumClass}`;
            dayNum.textContent = day;
            div.appendChild(dayNum);
            
            // æ˜¾ç¤ºè€ƒå‹¤ä¿¡æ¯
            if (record) {
                const isHoliday = record.holiday || record.isHoliday;
                const isLeave = record.leave || record.isLeave;
                
                // èŠ‚å‡æ—¥æ ‡è®°
                if (isHoliday) {
                    const holidayTag = document.createElement('div');
                    holidayTag.className = 'text-xs bg-red-500 text-white px-2 py-1 rounded mb-1 font-semibold';
                    holidayTag.textContent = 'ğŸ‰ èŠ‚å‡æ—¥';
                    div.appendChild(holidayTag);
                }
                
                // è°ƒä¼‘å·¥ä½œæ—¥æ ‡è®°
                if (isMakeupWorkday) {
                    const makeupTag = document.createElement('div');
                    makeupTag.className = 'text-xs bg-blue-500 text-white px-2 py-1 rounded mb-1 font-semibold';
                    makeupTag.textContent = 'ğŸ“… è°ƒä¼‘';
                    div.appendChild(makeupTag);
                }
                
                // è¯·å‡æ ‡è®°ï¼ˆéèŠ‚å‡æ—¥æ‰æ˜¾ç¤ºï¼‰
                if (isLeave && !isHoliday) {
                    const leaveTag = document.createElement('div');
                    leaveTag.className = 'text-xs bg-yellow-500 text-white px-2 py-1 rounded mb-1 font-semibold';
                    const leaveTypeText = record.leaveType === 'FULL_DAY' ? 'å…¨å¤©' :
                                         record.leaveType === 'MORNING' ? 'ä¸Šåˆ' :
                                         record.leaveType === 'AFTERNOON' ? 'ä¸‹åˆ' : '';
                    leaveTag.textContent = `ğŸ–ï¸ è¯·å‡${leaveTypeText ? '('+leaveTypeText+')' : ''}`;
                    div.appendChild(leaveTag);
                }
                
                // å·¥æ—¶ä¿¡æ¯ï¼ˆéèŠ‚å‡æ—¥æ‰æ˜¾ç¤ºï¼Œæˆ–èŠ‚å‡æ—¥åŠ ç­ï¼‰
                if (!isHoliday && (record.startTime || record.endTime)) {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'text-xs text-gray-600 space-y-1';
                    
                    if (record.startTime) {
                        const startSpan = document.createElement('div');
                        startSpan.className = 'flex items-center gap-1';
                        startSpan.innerHTML = `<span class="font-semibold">ä¸Š:</span> ${record.startTime}`;
                        timeDiv.appendChild(startSpan);
                    }
                    
                    if (record.endTime) {
                        const endSpan = document.createElement('div');
                        endSpan.className = 'flex items-center gap-1';
                        endSpan.innerHTML = `<span class="font-semibold">ä¸‹:</span> ${record.endTime}`;
                        timeDiv.appendChild(endSpan);
                    }
                    
                    div.appendChild(timeDiv);
                }
                
                // å·¥æ—¶ï¼ˆéèŠ‚å‡æ—¥æ‰æ˜¾ç¤ºï¼Œæˆ–æ˜¾ç¤ºèŠ‚å‡æ—¥åŠ ç­ï¼‰
                if (record.workHours > 0) {
                    if (isHoliday) {
                        // èŠ‚å‡æ—¥åŠ ç­æ ‡è®°
                        const overtimeDiv = document.createElement('div');
                        overtimeDiv.className = 'text-xs font-bold text-orange-600 mt-1';
                        overtimeDiv.textContent = `ğŸ’¼ åŠ ç­ ${record.workHours.toFixed(1)}h`;
                        div.appendChild(overtimeDiv);
                    } else {
                        const hoursDiv = document.createElement('div');
                        hoursDiv.className = 'text-xs font-bold text-blue-600 mt-1';
                        hoursDiv.textContent = `â±ï¸ ${record.workHours.toFixed(1)}h`;
                        div.appendChild(hoursDiv);
                    }
                }
                
                // è¯·å‡æ—¶é•¿
                if (record.leaveHours > 0) {
                    const leaveHoursDiv = document.createElement('div');
                    leaveHoursDiv.className = 'text-xs font-bold text-yellow-600 mt-1';
                    leaveHoursDiv.textContent = `ğŸ–ï¸ ${record.leaveHours.toFixed(1)}h`;
                    div.appendChild(leaveHoursDiv);
                }
            }
            
            // ç‚¹å‡»äº‹ä»¶
            div.onclick = () => showDayDetails(dateStr, record);
            
            return div;
        }

        // æ˜¾ç¤ºæ—¥æœŸè¯¦æƒ…
        function showDayDetails(dateStr, record) {
            if (!record) {
                alert(`${dateStr}\næš‚æ— è€ƒå‹¤è®°å½•`);
                return;
            }
            
            let details = `ğŸ“… ${dateStr}\n\n`;
            
            const isHoliday = record.holiday || record.isHoliday;
            const isWorkday = record.workday || record.isWorkday;
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const isMakeupWorkday = isWeekend && isWorkday && !isHoliday;
            
            if (isHoliday) {
                details += `ğŸ‰ æ³•å®šèŠ‚å‡æ—¥\n\n`;
            } else if (isMakeupWorkday) {
                details += `ğŸ“… è°ƒä¼‘å·¥ä½œæ—¥ï¼ˆå‘¨æœ«ä¸Šç­ï¼‰\n\n`;
            } else if (isWorkday) {
                details += `ğŸ“Œ å·¥ä½œæ—¥\n`;
            } else {
                details += `ğŸ“Œ å‘¨æœ«\n`;
            }
            
            if (record.startTime || record.endTime) {
                details += `\nâ° è€ƒå‹¤æ—¶é—´ï¼š\n`;
                details += `   ä¸Šç­: ${record.startTime || 'æœªæ‰“å¡'}\n`;
                details += `   ä¸‹ç­: ${record.endTime || 'æœªæ‰“å¡'}\n`;
            }
            
            if (record.workHours > 0) {
                details += `\nâ±ï¸ å·¥æ—¶: ${record.workHours.toFixed(2)} å°æ—¶\n`;
            }
            
            if (record.leave || record.isLeave) {
                details += `\nğŸ–ï¸ è¯·å‡ä¿¡æ¯ï¼š\n`;
                const leaveTypeText = record.leaveType === 'FULL_DAY' ? 'å…¨å¤©è¯·å‡' :
                                     record.leaveType === 'MORNING' ? 'ä¸Šåˆè¯·å‡' :
                                     record.leaveType === 'AFTERNOON' ? 'ä¸‹åˆè¯·å‡' : 'è¯·å‡';
                details += `   ç±»å‹: ${leaveTypeText}\n`;
                details += `   æ—¶é•¿: ${record.leaveHours.toFixed(2)} å°æ—¶\n`;
            }
            
            if (record.remark) {
                details += `\nğŸ“ å¤‡æ³¨: ${record.remark}\n`;
            }
            
            alert(details);
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateSummary() {
            if (statistics) {
                document.getElementById('summaryTotalHours').textContent = statistics.totalWorkHours.toFixed(1);
                document.getElementById('summaryLeaveHours').textContent = statistics.totalLeaveHours.toFixed(1);
                document.getElementById('summaryAvgHours').textContent = statistics.averageWorkHoursPerDay.toFixed(1);
                
                // æ›´æ–°æ–°å¢çš„ç»Ÿè®¡æ•°æ®
                const lateNightCount = statistics.lateNightCheckInCount || 0;
                const actualDays = statistics.actualAttendanceDays || 0;
                const attendanceDays = statistics.attendanceDays || 0;
                
                document.getElementById('summaryLateNightCount').textContent = lateNightCount;
                document.getElementById('summaryActualDays').textContent = actualDays;
                document.getElementById('summaryAttendanceDays').textContent = attendanceDays;
                
                // æ ¹æ®æ˜¯å¦è¾¾åˆ°æ¨èæ¬¡æ•°æ”¹å˜é¢œè‰²
                const lateNightEl = document.getElementById('summaryLateNightCount');
                lateNightEl.className = lateNightCount >= 13 ? 'text-3xl font-bold text-green-600' : 'text-3xl font-bold text-orange-600';
                
                const actualDaysEl = document.getElementById('summaryActualDays');
                actualDaysEl.className = actualDays >= 21 ? 'text-3xl font-bold text-green-600' : 'text-3xl font-bold text-green-600';
            }
        }

        // æœˆä»½å¯¼èˆª
        function previousMonth() {
            const [year, month] = currentMonth.split('-').map(Number);
            const newDate = new Date(year, month - 2, 1);
            currentMonth = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('calendarMonth').value = currentMonth;
            loadCalendar();
        }

        function nextMonth() {
            const [year, month] = currentMonth.split('-').map(Number);
            const newDate = new Date(year, month, 1);
            currentMonth = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('calendarMonth').value = currentMonth;
            loadCalendar();
        }

        function goToday() {
            currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('calendarMonth').value = currentMonth;
            loadCalendar();
        }

        // åŠ è½½å’Œéšè—åŠ¨ç”»
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    </script>
</body>
</html>
