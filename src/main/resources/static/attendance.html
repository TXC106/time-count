<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å¡è€ƒå‹¤ - å·¥æ—¶è®¡ç®—ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .scale-in {
            animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .btn-primary {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-12 fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg mb-6 scale-in">
                <i data-lucide="check-circle" class="w-10 h-10 text-white"></i>
            </div>
            <h1 class="text-6xl font-bold bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 bg-clip-text text-transparent mb-4">
                æ‰“å¡è€ƒå‹¤
            </h1>
            <p class="text-gray-600 text-lg mb-8 font-medium">
                è®°å½•æ¯å¤©çš„ä¸Šä¸‹ç­æ—¶é—´ï¼Œæ”¯æŒè¯·å‡è®¾ç½®
            </p>
            <div class="flex flex-wrap justify-center gap-3">
                <a href="/" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-xl hover:from-indigo-700 hover:to-indigo-800 transition-all font-semibold shadow-lg hover:shadow-xl btn-primary">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    ç»Ÿè®¡é¢æ¿
                </a>
                <a href="/attendance.html" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-xl hover:from-emerald-700 hover:to-emerald-800 transition-all font-semibold shadow-lg hover:shadow-xl btn-primary">
                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                    æ‰“å¡è€ƒå‹¤
                </a>
                <a href="/config.html" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-amber-600 to-amber-700 text-white rounded-xl hover:from-amber-700 hover:to-amber-800 transition-all font-semibold shadow-lg hover:shadow-xl btn-primary">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    é…ç½®ç®¡ç†
                </a>
                <a href="/calendar.html" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl hover:from-purple-700 hover:to-purple-800 transition-all font-semibold shadow-lg hover:shadow-xl btn-primary">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    æ—¥å†è§†å›¾
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <div class="bg-white rounded-3xl shadow-2xl p-8 transition-all duration-300 scale-in max-w-2xl mx-auto border border-emerald-100">
            <div class="flex items-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-white shadow-md mr-4">
                    <i data-lucide="clipboard-check" class="w-8 h-8"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">æ‰“å¡è€ƒå‹¤</h2>
                    <p class="text-gray-600 mt-1">è®°å½•æ‚¨çš„å·¥ä½œæ—¶é—´å’Œè¯·å‡ä¿¡æ¯</p>
                </div>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        é€‰æ‹©æ—¥æœŸ <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="date" 
                        id="attendanceDate" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                    >
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ä¸Šç­æ—¶é—´
                        </label>
                        <input 
                            type="time" 
                            id="attendanceStartTime" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ä¸‹ç­æ—¶é—´
                        </label>
                        <div class="flex items-center gap-3">
                            <input 
                                type="time" 
                                id="attendanceEndTime" 
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                            >
                            <label class="flex items-center gap-2 cursor-pointer whitespace-nowrap">
                                <input 
                                    type="checkbox" 
                                    id="endTimeNextDay" 
                                    class="w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                >
                                <span class="text-sm font-medium text-gray-700">æ¬¡æ—¥</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        è¯·å‡å¼€å§‹æ—¶é—´
                    </label>
                    <input 
                        type="time" 
                        id="leaveStartTime" 
                        placeholder="å¦‚æœ‰è¯·å‡ï¼Œè¯·é€‰æ‹©å¼€å§‹æ—¶é—´"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        è¯·å‡ç»“æŸæ—¶é—´
                    </label>
                    <input 
                        type="time" 
                        id="leaveEndTime" 
                        placeholder="å¦‚æœ‰è¯·å‡ï¼Œè¯·é€‰æ‹©ç»“æŸæ—¶é—´"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                    >
                </div>
                
                <!-- ç”¨é¤æ—¶é—´é¢„è§ˆ -->
                <div id="mealPreview" class="hidden">
                    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                        <p class="text-blue-800 font-medium mb-2">ğŸ´ ç”¨é¤æ—¶é—´é¢„è§ˆ</p>
                        <div id="mealPreviewContent" class="text-sm text-blue-700"></div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        å¤‡æ³¨
                    </label>
                    <textarea 
                        id="attendanceRemark" 
                        placeholder="å¯é€‰ï¼šå¡«å†™è¯·å‡åŸå› æˆ–å…¶ä»–è¯´æ˜"
                        rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg resize-none"
                    ></textarea>
                </div>
                
                <button 
                    onclick="submitAttendance()" 
                    class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-semibold py-4 px-6 rounded-xl transition-all text-lg shadow-lg hover:shadow-xl btn-primary flex items-center justify-center gap-2"
                >
                    <i data-lucide="check" class="w-5 h-5"></i>
                    <span id="attendanceBtn">æäº¤æ‰“å¡</span>
                </button>
            </div>
            
            <div id="attendanceResult" class="mt-6"></div>
            
            <div class="mt-6 space-y-3">
                <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                    <p class="text-blue-800">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>ä¸‹åˆè¯·å‡ä¸ä¼šæ‰£é™¤åˆä¼‘æ—¶é—´
                    </p>
                </div>
                <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded">
                    <p class="text-green-800">
                        <strong>âœ“ æ­£å¸¸å‡ºå‹¤ï¼š</strong>å¡«å†™ä¸Šç­å’Œä¸‹ç­æ—¶é—´å³å¯
                    </p>
                </div>
                <div class="p-4 bg-purple-50 border-l-4 border-purple-400 rounded">
                    <p class="text-purple-800">
                        <strong>ğŸŒ™ è·¨å¤©æ‰“å¡ï¼š</strong>
                    </p>
                    <ul class="mt-2 space-y-1 text-sm text-purple-700 ml-4">
                        <li>â€¢ å¦‚æœä¸‹ç­æ—¶é—´æ˜¯ç¬¬äºŒå¤©ï¼Œè¯·å‹¾é€‰<strong>"æ¬¡æ—¥"</strong>å¤é€‰æ¡†</li>
                        <li>â€¢ ä¾‹å¦‚ï¼š22:00ä¸Šç­ï¼Œæ¬¡æ—¥06:00ä¸‹ç­ï¼ˆå‹¾é€‰"æ¬¡æ—¥"ï¼‰= 8å°æ—¶</li>
                    </ul>
                </div>
                <div class="p-4 bg-orange-50 border-l-4 border-orange-400 rounded">
                    <p class="text-orange-800">
                        <strong>ğŸ–ï¸ è¯·å‡è¯´æ˜ï¼š</strong>
                    </p>
                    <ul class="mt-2 space-y-1 text-sm text-orange-700 ml-4">
                        <li>â€¢ <strong>è¯·å‡æ—¶é—´æ®µï¼š</strong>å¡«å†™è¯·å‡å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—è¯·å‡æ—¶é•¿</li>
                        <li>â€¢ <strong>ä¸Šåˆè¯·å‡ï¼š</strong>09:00-12:00ï¼Œ<strong>ä¸‹åˆè¯·å‡ï¼š</strong>13:00-18:00</li>
                        <li>â€¢ <strong>ç”¨é¤æ—¶é—´ï¼š</strong>å¡«å†™ä¸Šä¸‹ç­æ—¶é—´åï¼Œç³»ç»Ÿä¼šé¢„è§ˆå°†æ‰£é™¤çš„ç”¨é¤æ—¶é—´</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 pb-8">
            <div class="flex items-center justify-center gap-2 mb-2">
                <i data-lucide="code" class="w-4 h-4"></i>
                <p class="font-medium">å·¥æ—¶è®¡ç®—ç³»ç»Ÿ v1.0</p>
            </div>
            <p class="text-sm">Spring Boot + Apache POI + TailwindCSS</p>
        </footer>
    </div>

    <script>
        // åˆå§‹åŒ– Lucide å›¾æ ‡
        lucide.createIcons();
    </script>

    <script>
        // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤å€¼
        const currentDate = new Date().toISOString().slice(0, 10);
        document.getElementById('attendanceDate').value = currentDate;
        
        // ç›‘å¬æ—¶é—´è¾“å…¥å˜åŒ–ï¼Œå®æ—¶é¢„è§ˆç”¨é¤æ—¶é—´
        document.getElementById('attendanceStartTime').addEventListener('input', updateMealPreview);
        document.getElementById('attendanceEndTime').addEventListener('input', updateMealPreview);
        document.getElementById('leaveStartTime').addEventListener('input', updateMealPreview);
        document.getElementById('leaveEndTime').addEventListener('input', updateMealPreview);
        
        // ä»URLå‚æ•°ä¸­è·å–é¢„å¡«æ•°æ®
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        const startTimeParam = urlParams.get('startTime');
        const endTimeParam = urlParams.get('endTime');
        
        if (dateParam) {
            document.getElementById('attendanceDate').value = dateParam;
        }
        if (startTimeParam && startTimeParam !== 'null') {
            document.getElementById('attendanceStartTime').value = startTimeParam;
        }
        if (endTimeParam && endTimeParam !== 'null') {
            document.getElementById('attendanceEndTime').value = endTimeParam;
        }

        // æäº¤è€ƒå‹¤æ‰“å¡
        async function submitAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const startTime = document.getElementById('attendanceStartTime').value;
            let endTime = document.getElementById('attendanceEndTime').value;
            const endTimeNextDay = document.getElementById('endTimeNextDay').checked;
            const leaveStartTime = document.getElementById('leaveStartTime').value;
            const leaveEndTime = document.getElementById('leaveEndTime').value;
            const remark = document.getElementById('attendanceRemark').value;
            const resultDiv = document.getElementById('attendanceResult');
            const btn = document.getElementById('attendanceBtn');
            
            if (!date) {
                showMessage(resultDiv, 'è¯·é€‰æ‹©æ—¥æœŸ', 'error');
                return;
            }

            // å¦‚æœä¸‹ç­æ—¶é—´æ˜¯æ¬¡æ—¥ï¼Œæ·»åŠ +1æ ‡è®°
            if (endTime && endTimeNextDay) {
                endTime = endTime + '+1';
            }

            btn.innerHTML = '<span class="loading"></span>';
            
            try {
                const requestBody = {
                    date: date,
                    startTime: startTime || null,
                    endTime: endTime || null,
                    leaveStartTime: leaveStartTime || null,
                    leaveEndTime: leaveEndTime || null,
                    remark: remark || null
                };

                const response = await fetch('/api/workhours/attendance/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(resultDiv, 'âœ… æ‰“å¡æˆåŠŸï¼æ•°æ®å·²åŒæ­¥åˆ°Excelæ–‡ä»¶', 'success');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('attendanceStartTime').value = '';
                    document.getElementById('attendanceEndTime').value = '';
                    document.getElementById('endTimeNextDay').checked = false;
                    document.getElementById('leaveStartTime').value = '';
                    document.getElementById('leaveEndTime').value = '';
                    document.getElementById('attendanceRemark').value = '';
                    updateMealPreview();
                } else {
                    showMessage(resultDiv, `âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(resultDiv, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = 'âœ“ æäº¤æ‰“å¡';
            }
        }

        // æ›´æ–°ç”¨é¤æ—¶é—´é¢„è§ˆ
        function updateMealPreview() {
            const startTime = document.getElementById('attendanceStartTime').value;
            const endTime = document.getElementById('attendanceEndTime').value;
            const leaveStartTime = document.getElementById('leaveStartTime').value;
            const leaveEndTime = document.getElementById('leaveEndTime').value;
            const previewDiv = document.getElementById('mealPreview');
            const contentDiv = document.getElementById('mealPreviewContent');
            
            if (!startTime || !endTime) {
                previewDiv.classList.add('hidden');
                return;
            }
            
            // è®¡ç®—ç”¨é¤æ—¶é—´æ‰£é™¤
            let mealDeduction = 0;
            let explanation = '';
            
            const endHour = parseInt(endTime.split(':')[0]);
            
            // åˆ¤æ–­æ˜¯å¦ä¸‹åˆè¯·å‡ï¼ˆè¯·å‡æ—¶é—´åŒ…å«13:00-18:00ï¼‰
            let isAfternoonLeave = false;
            if (leaveStartTime && leaveEndTime) {
                const leaveStart = parseInt(leaveStartTime.split(':')[0]) * 60 + parseInt(leaveStartTime.split(':')[1]);
                const leaveEnd = parseInt(leaveEndTime.split(':')[0]) * 60 + parseInt(leaveEndTime.split(':')[1]);
                const afternoonStart = 13 * 60; // 13:00
                const afternoonEnd = 18 * 60;   // 18:00
                
                // è¯·å‡æ—¶é—´åŒ…å«ä¸‹åˆæ—¶æ®µ
                if (leaveStart < afternoonEnd && leaveEnd > afternoonStart) {
                    isAfternoonLeave = true;
                }
            }
            
            if (isAfternoonLeave) {
                // ä¸‹åˆè¯·å‡ï¼Œä¸æ‰£é™¤ç”¨é¤æ—¶é—´
                explanation = `ğŸŸ¢ ä¸‹åˆè¯·å‡ï¼ˆ${leaveStartTime}~${leaveEndTime}ï¼‰ï¼Œ<strong>ä¸æ‰£é™¤ç”¨é¤æ—¶é—´</strong>`;
            } else if (endHour < 19) {
                // 19ç‚¹å‰æ‰“ä¸‹ç­å¡ï¼Œæ‰£å‡1å°æ—¶ç”¨é¤æ—¶é—´
                mealDeduction = 1.0;
                explanation = `ğŸŸ¡ ä¸‹ç­æ—¶é—´ <strong>${endTime}</strong> æ—©äº19:00ï¼Œå°†æ‰£é™¤ <strong>1å°æ—¶</strong> ç”¨é¤æ—¶é—´ï¼ˆåˆé¤ï¼‰`;
            } else {
                // 19ç‚¹åŠä¹‹åæ‰“ä¸‹ç­å¡ï¼Œæ‰£å‡1.5å°æ—¶ç”¨é¤æ—¶é—´
                mealDeduction = 1.5;
                explanation = `ğŸ”´ ä¸‹ç­æ—¶é—´ <strong>${endTime}</strong> æ™šäºæˆ–19:00ï¼Œå°†æ‰£é™¤ <strong>1.5å°æ—¶</strong> ç”¨é¤æ—¶é—´ï¼ˆ1å°æ—¶åˆé¤ + 0.5å°æ—¶æ™šé¤ï¼‰`;
            }
            
            // è®¡ç®—å®é™…å·¥æ—¶
            const start = new Date(`2000-01-01 ${startTime}`);
            const end = new Date(`2000-01-01 ${endTime}`);
            const totalHours = (end - start) / (1000 * 60 * 60);
            const workHours = Math.max(0, totalHours - mealDeduction);
            
            contentDiv.innerHTML = `
                <div>${explanation}</div>
                <div class="mt-2">
                    <span class="font-semibold">å®é™…å·¥æ—¶ï¼š</span>
                    ${totalHours.toFixed(2)}å°æ—¶ - ${mealDeduction}å°æ—¶ = <strong class="text-lg">${workHours.toFixed(2)}å°æ—¶</strong>
                </div>
            `;
            
            previewDiv.classList.remove('hidden');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(element, message, type) {
            const bgColor = type === 'success' ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800';
            element.innerHTML = `
                <div class="${bgColor} border-l-4 p-4 rounded text-sm animate-pulse">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                if (type === 'success') {
                    element.innerHTML = '';
                }
            }, 5000);
        }
    </script>
</body>
</html>
