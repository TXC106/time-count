<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ—¶è®¡ç®—ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-12 fade-in">
            <h1 class="text-5xl font-bold text-indigo-900 mb-4">
                ğŸ“Š å·¥æ—¶è®¡ç®—ç³»ç»Ÿ
            </h1>
            <p class="text-gray-600 text-lg mb-6">
                æ™ºèƒ½è€ƒå‹¤ç®¡ç† Â· è‡ªåŠ¨å·¥æ—¶ç»Ÿè®¡ Â· æ•°æ®å¯è§†åŒ–åˆ†æ
            </p>
            <div class="flex justify-center gap-4">
                <a href="/" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                    ğŸ“Š ç»Ÿè®¡é¢æ¿
                </a>
                <a href="/attendance.html" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                    âœ“ æ‰“å¡è€ƒå‹¤
                </a>
                <a href="/config.html" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold">
                    âš™ï¸ é…ç½®ç®¡ç†
                </a>
                <a href="/calendar.html" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                    ğŸ“… æ—¥å†è§†å›¾
                </a>
            </div>
        </header>

        <!-- åŠŸèƒ½åŒº -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <!-- åŠŸèƒ½3: ç”Ÿæˆæ¨¡æ¿ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all duration-300 fade-in">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl mr-4">
                        ğŸ“
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">ç”Ÿæˆæ¨¡æ¿</h2>
                </div>
                <p class="text-gray-600 mb-6">
                    è‡ªåŠ¨ç”ŸæˆæŒ‡å®šæœˆä»½çš„è€ƒå‹¤è¡¨æ ¼æ¨¡æ¿ï¼ŒåŒ…å«æ—¥æœŸã€æ˜ŸæœŸç­‰ä¿¡æ¯ã€‚
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é€‰æ‹©æœˆä»½
                        </label>
                        <input
                            type="month"
                            id="templateMonth"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>

                    <button
                        onclick="generateTemplate()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 active:scale-95"
                    >
                        <span id="generateBtn">ç”Ÿæˆæ¨¡æ¿</span>
                    </button>
                </div>

                <div id="generateResult" class="mt-4"></div>
            </div>

            <!-- åŠŸèƒ½4: å¡«å†™è¯´æ˜ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all duration-300 fade-in">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-cyan-500 rounded-full flex items-center justify-center text-white text-2xl mr-4">
                        âœï¸
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">å¡«å†™è¯´æ˜</h2>
                </div>
                <p class="text-gray-600 mb-6">
                    æ‰“å¡æ–¹å¼è¯´æ˜ã€‚
                </p>

                <div class="bg-blue-50 rounded-lg p-4 space-y-3">
                    <h3 class="font-semibold text-gray-800 mb-2">ğŸ“‹ æ‰“å¡æ–¹å¼ï¼š</h3>
                    <ol class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0 text-xs">1</span>
                            <span>ä½¿ç”¨â€œæ‰“å¡è€ƒå‹¤â€é¡µé¢åœ¨çº¿æäº¤</span>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0 text-xs">2</span>
                            <span>ä½¿ç”¨ä¸‹æ–¹â€œåœ¨çº¿å¡«å†™â€åŠŸèƒ½æ‰¹é‡ç¼–è¾‘</span>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0 text-xs">3</span>
                            <span>æˆ–æ‰‹åŠ¨åœ¨Excelæ–‡ä»¶ä¸­å¡«å†™æ—¶é—´</span>
                        </li>
                    </ol>
                </div>

                <div class="mt-4">
                    <button
                        onclick="openExcelEditor()"
                        class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 active:scale-95"
                    >
                        ğŸ“ åœ¨çº¿å¡«å†™Excel
                    </button>
                </div>

                <div class="bg-green-50 rounded-lg p-4 space-y-3 mt-4">
                    <h3 class="font-semibold text-gray-800 mb-2">ğŸ“ Excelæ‰‹åŠ¨å¡«å†™ï¼š</h3>
                    <ol class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0 text-xs">1</span>
                            <span>æ‰“å¼€ <code class="bg-gray-200 px-1 rounded">data</code> ç›®å½•ä¸‹çš„Excelæ–‡ä»¶</span>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0 text-xs">2</span>
                            <span>å¡«å†™"ä¸Šç­æ—¶é—´"å’Œ"ä¸‹ç­æ—¶é—´"åˆ—</span>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 flex-shrink-0 text-xs">3</span>
                            <span>æ ¼å¼ï¼š<code class="bg-gray-200 px-1 rounded font-mono">8:56</code></span>
                        </li>
                    </ol>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <p class="text-sm text-yellow-800">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>æ¨èä½¿ç”¨åœ¨çº¿æ‰“å¡ï¼Œæ•°æ®è‡ªåŠ¨åŒæ­¥
                    </p>
                </div>
            </div>

            <!-- åŠŸèƒ½5: è®¡ç®—å·¥æ—¶ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all duration-300 fade-in">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center text-white text-2xl mr-4">
                        ğŸ”¢
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">è®¡ç®—å·¥æ—¶</h2>
                </div>
                <p class="text-gray-600 mb-6">
                    è‡ªåŠ¨è®¡ç®—å·¥æ—¶ç»Ÿè®¡ï¼ŒåŒ…æ‹¬æ€»å·¥æ—¶ã€å¹³å‡å·¥æ—¶ã€è¯·å‡ç»Ÿè®¡ç­‰ã€‚
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é€‰æ‹©æœˆä»½
                        </label>
                        <input
                            type="month"
                            id="calculateMonth"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                    </div>

                    <button
                        onclick="calculateWorkHours()"
                        class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 active:scale-95"
                    >
                        <span id="calculateBtn">è®¡ç®—å·¥æ—¶</span>
                    </button>
                </div>

                <div id="calculateResult" class="mt-4"></div>
            </div>
        </div>

        <!-- Excelåœ¨çº¿ç¼–è¾‘å¼¹çª— -->
        <div id="excelEditorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
                <div class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white p-6 flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold">ğŸ“ åœ¨çº¿Excelç¼–è¾‘å™¨</h2>
                        <p class="text-cyan-100 mt-1" id="excelEditorTitle">é€‰æ‹©æœˆä»½å¹¶ç¼–è¾‘è€ƒå‹¤æ•°æ®</p>
                    </div>
                    <button
                        onclick="closeExcelEditor()"
                        class="text-white hover:text-gray-200 text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-white hover:bg-opacity-20 transition-all"
                    >
                        Ã—
                    </button>
                </div>

                <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px);">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é€‰æ‹©æœˆä»½
                        </label>
                        <div class="flex gap-3">
                            <input
                                type="month"
                                id="excelEditorMonth"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                            >
                            <button
                                onclick="loadExcelData()"
                                class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg transition-all"
                            >
                                <span id="loadExcelBtn">ğŸ”„ åŠ è½½æ•°æ®</span>
                            </button>
                        </div>
                    </div>

                    <div id="excelDataContainer" class="hidden">
                        <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                            <p class="text-blue-800 text-sm">
                                <strong>ğŸ’¡ æç¤ºï¼š</strong>ç›´æ¥åœ¨è¡¨æ ¼ä¸­ä¿®æ”¹æ—¶é—´ï¼Œä¿®æ”¹åè‡ªåŠ¨ä¿å­˜åˆ°Excelæ–‡ä»¶
                            </p>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 border-b text-left text-sm font-semibold text-gray-700">æ—¥æœŸ</th>
                                        <th class="px-4 py-3 border-b text-left text-sm font-semibold text-gray-700">æ˜ŸæœŸ</th>
                                        <th class="px-4 py-3 border-b text-left text-sm font-semibold text-gray-700">ä¸Šç­æ—¶é—´</th>
                                        <th class="px-4 py-3 border-b text-left text-sm font-semibold text-gray-700">ä¸‹ç­æ—¶é—´</th>
                                        <th class="px-4 py-3 border-b text-left text-sm font-semibold text-gray-700">è¯·å‡ç±»å‹</th>
                                        <th class="px-4 py-3 border-b text-left text-sm font-semibold text-gray-700">å·¥æ—¶</th>
                                    </tr>
                                </thead>
                                <tbody id="excelTableBody">
                                    <!-- æ•°æ®å°†åŠ¨æ€æ’å…¥ -->
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button
                                onclick="closeExcelEditor()"
                                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition-all"
                            >
                                å…³é—­
                            </button>
                        </div>
                    </div>

                    <div id="excelLoadingMessage" class="text-center py-12 text-gray-500">
                        è¯·é€‰æ‹©æœˆä»½å¹¶ç‚¹å‡»â€œåŠ è½½æ•°æ®â€
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æŠ¥å‘ŠåŒºåŸŸ -->
        <div id="reportSection" class="hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">ğŸ“ˆ å·¥æ—¶ç»Ÿè®¡æŠ¥å‘Š</h2>
                    <button
                        onclick="closeReport()"
                        class="text-gray-500 hover:text-gray-700 text-2xl"
                    >
                        âœ•
                    </button>
                </div>

                <div id="reportContent" class="space-y-6">
                    <!-- æŠ¥å‘Šå†…å®¹å°†åŠ¨æ€æ’å…¥ -->
                </div>
            </div>
        </div>

        <!-- è®¡ç®—è§„åˆ™è¯´æ˜ -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mt-8 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="text-3xl mr-3">â„¹ï¸</span>
                å·¥æ—¶è®¡ç®—è§„åˆ™
            </h2>

            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <h3 class="font-semibold text-lg text-gray-800 mb-3">ğŸ“Œ åŸºæœ¬è§„åˆ™</h3>
                    <ul class="space-y-2 text-gray-700 text-sm">
                        <li class="flex items-start">
                            <span class="text-blue-500 mr-2">â€¢</span>
                            <span>å·¥æ—¶ = ä¸‹ç­ - ä¸Šç­ - åˆä¼‘ - æ™šé¤</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-500 mr-2">â€¢</span>
                            <span>æ­£å¸¸æƒ…å†µæ‰£é™¤åˆä¼‘æ—¶é—´ï¼ˆé»˜è®¤1å°æ—¶ï¼‰</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-500 mr-2">â€¢</span>
                            <span>ä¸‹ç­æ™šäºä¸´ç•Œç‚¹æ‰£é™¤æ™šé¤æ—¶é—´ï¼ˆé»˜è®¤19ç‚¹åæ‰£0.5å°æ—¶ï¼‰</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-500 mr-2">â€¢</span>
                            <span>æ‰€æœ‰æ—¶é—´å‚æ•°å¯åœ¨é…ç½®ç®¡ç†ä¸­è‡ªå®šä¹‰</span>
                        </li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-lg text-gray-800 mb-3">ğŸ–ï¸ è¯·å‡è§„åˆ™</h3>
                    <ul class="space-y-2 text-gray-700 text-sm">
                        <li class="flex items-start">
                            <span class="text-orange-500 mr-2">â€¢</span>
                            <span><strong>å…¨å¤©è¯·å‡ï¼š</strong>ä¸å¡«ä¸Šä¸‹ç­æ—¶é—´</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-orange-500 mr-2">â€¢</span>
                            <span><strong>ä¸Šåˆè¯·å‡ï¼š</strong>åªå¡«ä¸‹ç­æ—¶é—´</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-orange-500 mr-2">â€¢</span>
                            <span><strong>ä¸‹åˆè¯·å‡ï¼š</strong>åªå¡«ä¸Šç­æ—¶é—´ï¼Œ<em>ä¸æ‰£åˆä¼‘</em></span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-orange-500 mr-2">â€¢</span>
                            <span>ä¸Šç­æ™šäºæ ‡å‡†æ—¶é—´ï¼ˆé»˜è®¤9ç‚¹ï¼‰æˆ–ä¸‹ç­æ—©äºæ ‡å‡†æ—¶é—´ï¼ˆé»˜è®¤18ç‚¹ï¼‰è§†ä¸ºè¯·å‡</span>
                        </li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-lg text-gray-800 mb-3">âš™ï¸ è‡ªå®šä¹‰é…ç½®</h3>
                    <ul class="space-y-2 text-gray-700 text-sm">
                        <li class="flex items-start">
                            <span class="text-green-500 mr-2">â€¢</span>
                            <span><strong>æœŸæœ›æ€»å·¥æ—¶ï¼š</strong>ç”¨äºè®¡ç®—ç›®æ ‡å·®è·</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-green-500 mr-2">â€¢</span>
                            <span><strong>åˆä¼‘æ—¶é—´ï¼š</strong>æ¯å¤©æ‰£é™¤çš„åˆä¼‘æ—¶é•¿</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-green-500 mr-2">â€¢</span>
                            <span><strong>æ™šé¤æ—¶é—´ï¼š</strong>åŠ ç­æ—¶æ‰£é™¤çš„æ™šé¤æ—¶é•¿</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-green-500 mr-2">â€¢</span>
                            <span><strong>æ ‡å‡†å·¥æ—¶ï¼š</strong>ç”¨äºåˆ¤å®šè¿Ÿåˆ°æ—©é€€</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-600">
            <p>å·¥æ—¶è®¡ç®—ç³»ç»Ÿ v1.0 | Spring Boot + Apache POI</p>
        </footer>
    </div>

    <script>
        // è®¾ç½®å½“å‰æœˆä»½ä¸ºé»˜è®¤å€¼
        const currentMonth = new Date().toISOString().slice(0, 7);
        document.getElementById('templateMonth').value = currentMonth;
        document.getElementById('calculateMonth').value = currentMonth;

        // ç”Ÿæˆæ¨¡æ¿
        async function generateTemplate() {
            const month = document.getElementById('templateMonth').value;
            const resultDiv = document.getElementById('generateResult');
            const btn = document.getElementById('generateBtn');

            if (!month) {
                showMessage(resultDiv, 'è¯·é€‰æ‹©æœˆä»½', 'error');
                return;
            }

            btn.innerHTML = '<span class="loading"></span>';

            try {
                const response = await fetch(`/api/workhours/template/generate?yearMonth=${month}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(resultDiv, `âœ… æ¨¡æ¿ç”ŸæˆæˆåŠŸï¼<br><small class="text-xs">æ–‡ä»¶è·¯å¾„: ${data.filePath}</small>`, 'success');
                } else {
                    showMessage(resultDiv, `âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(resultDiv, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.textContent = 'ç”Ÿæˆæ¨¡æ¿';
            }
        }

        // è®¡ç®—å·¥æ—¶
        async function calculateWorkHours() {
            const month = document.getElementById('calculateMonth').value;
            const resultDiv = document.getElementById('calculateResult');
            const btn = document.getElementById('calculateBtn');

            if (!month) {
                showMessage(resultDiv, 'è¯·é€‰æ‹©æœˆä»½', 'error');
                return;
            }

            btn.innerHTML = '<span class="loading"></span>';

            try {
                const response = await fetch(`/api/workhours/calculate?yearMonth=${month}`);
                const data = await response.json();

                if (data.success) {
                    showMessage(resultDiv, 'âœ… è®¡ç®—å®Œæˆï¼', 'success');
                    displayReport(data.statistics);
                } else {
                    showMessage(resultDiv, `âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(resultDiv, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.textContent = 'è®¡ç®—å·¥æ—¶';
            }
        }

        // æ˜¾ç¤ºæŠ¥å‘Š
        function displayReport(stats) {
            const reportSection = document.getElementById('reportSection');
            const reportContent = document.getElementById('reportContent');

            const html = `
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl p-6 mb-6">
                    <h3 class="text-2xl font-bold mb-2">${stats.yearMonth}</h3>
                    <p class="text-blue-100">å·¥æ—¶ç»Ÿè®¡æœˆåº¦æŠ¥å‘Š</p>
                </div>

                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">å½“æœˆæ€»å·¥æ—¶</div>
                        <div class="text-3xl font-bold text-blue-600">${stats.totalWorkHours}</div>
                        <div class="text-sm text-gray-500">å°æ—¶</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 relative group">
                        <div class="text-sm text-gray-600 mb-1 flex items-center gap-1">
                            å‡ºå‹¤å¤©æ•°
                            <span class="text-xs text-green-500 cursor-help">â„¹ï¸</span>
                        </div>
                        <div class="text-3xl font-bold ${stats.actualAttendanceDays >= 21 ? 'text-green-600' : 'text-green-600'}">${stats.actualAttendanceDays}</div>
                        <div class="text-sm text-gray-500">å¤©</div>
                        <div class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded py-2 px-3 bottom-full left-1/2 transform -translate-x-1/2 mb-2 whitespace-nowrap z-10">
                            æ¨è: 21å¤© | æœ‰å·¥æ—¶: ${stats.attendanceDays}å¤©
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                        </div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 relative group">
                        <div class="text-sm text-gray-600 mb-1 flex items-center gap-1">
                            21ç‚¹åæ‰“å¡
                            <span class="text-xs text-orange-500 cursor-help">â„¹ï¸</span>
                        </div>
                        <div class="text-3xl font-bold ${stats.lateNightCheckInCount >= 13 ? 'text-green-600' : 'text-orange-600'}">${stats.lateNightCheckInCount}</div>
                        <div class="text-sm text-gray-500">æ¬¡</div>
                        <div class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded py-2 px-3 bottom-full left-1/2 transform -translate-x-1/2 mb-2 whitespace-nowrap z-10">
                            æ¨èæ¬¡æ•°: 13æ¬¡
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                        </div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">æ—¥å¹³å‡å·¥æ—¶</div>
                        <div class="text-3xl font-bold text-purple-600">${stats.averageWorkHoursPerDay}</div>
                        <div class="text-sm text-gray-500">å°æ—¶/å¤©</div>
                    </div>
                </div>

                <div class="border-t pt-6">
                    <h4 class="font-bold text-lg mb-4">ğŸ¯ æœŸæœ›ç›®æ ‡</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="flex justify-between items-center bg-gray-50 rounded-lg p-4">
                            <span class="text-gray-700">æœŸæœ›æ€»å·¥æ—¶</span>
                            <span class="font-bold text-xl">${stats.expectedTotalHours} å°æ—¶</span>
                        </div>
                        <div class="flex justify-between items-center ${stats.remainingHoursToTarget > 0 ? 'bg-orange-50' : 'bg-green-50'} rounded-lg p-4">
                            <span class="text-gray-700">è·ç¦»ç›®æ ‡</span>
                            <span class="font-bold text-xl ${stats.remainingHoursToTarget > 0 ? 'text-orange-600' : 'text-green-600'}">
                                ${stats.remainingHoursToTarget > 0 ? '+' : ''}${stats.remainingHoursToTarget} å°æ—¶
                            </span>
                        </div>
                    </div>
                </div>

                <div class="border-t pt-6 mt-6">
                    <h4 class="font-bold text-lg mb-4">ğŸ“… å‰©ä½™è§„åˆ’</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="flex justify-between items-center bg-gray-50 rounded-lg p-4">
                            <span class="text-gray-700">å‰©ä½™å·¥ä½œæ—¥</span>
                            <span class="font-bold text-xl">${stats.remainingWorkdays} å¤©</span>
                        </div>
                        <div class="flex justify-between items-center bg-indigo-50 rounded-lg p-4">
                            <span class="text-gray-700">éœ€è¦æ—¥å‡å·¥æ—¶</span>
                            <span class="font-bold text-xl text-indigo-600">${stats.requiredAverageHoursForRemainingDays} å°æ—¶/å¤©</span>
                        </div>
                    </div>
                </div>

                ${stats.leaveDays > 0 ? `
                <div class="border-t pt-6 mt-6">
                    <h4 class="font-bold text-lg mb-4">ğŸ–ï¸ è¯·å‡ç»Ÿè®¡</h4>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="flex justify-between items-center bg-yellow-50 rounded-lg p-4">
                            <span class="text-gray-700">è¯·å‡å¤©æ•°</span>
                            <span class="font-bold text-xl text-yellow-600">${stats.leaveDays} å¤©</span>
                        </div>
                        <div class="flex justify-between items-center bg-yellow-50 rounded-lg p-4">
                            <span class="text-gray-700">è¯·å‡æ€»æ—¶é•¿</span>
                            <span class="font-bold text-xl text-yellow-600">${stats.totalLeaveHours} å°æ—¶</span>
                        </div>
                    </div>

                    ${stats.leaveRecords && stats.leaveRecords.length > 0 ? `
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-800 mb-3">ğŸ“‹ è¯·å‡æ˜ç»†</h5>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${stats.leaveRecords.map(record => {
                                const leaveTypeStr = record.leaveType && record.leaveType !== 'NONE'
                                    ? `<span class="px-2 py-1 text-xs rounded-full ${
                                        record.leaveType === 'FULL_DAY' ? 'bg-red-100 text-red-700' :
                                        record.leaveType === 'MORNING' ? 'bg-orange-100 text-orange-700' :
                                        record.leaveType === 'AFTERNOON' ? 'bg-blue-100 text-blue-700' : ''
                                    }">${record.leaveType === 'FULL_DAY' ? 'å…¨å¤©' :
                                        record.leaveType === 'MORNING' ? 'ä¸Šåˆ' :
                                        record.leaveType === 'AFTERNOON' ? 'ä¸‹åˆ' : ''}</span>`
                                    : '';

                                const timeStr = record.startTime || record.endTime
                                    ? `${record.startTime || 'æœªæ‰“å¡'} ~ ${record.endTime || 'æœªæ‰“å¡'}`
                                    : 'å…¨å¤©æœªæ‰“å¡';

                                return `
                                <div class="flex items-center justify-between bg-white rounded p-3 text-sm hover:shadow-md transition-shadow">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-medium text-gray-700">${record.date}</span>
                                        ${leaveTypeStr}
                                        <span class="text-gray-500 text-xs">${timeStr}</span>
                                    </div>
                                    <span class="font-semibold text-yellow-600">${record.leaveHours.toFixed(2)} å°æ—¶</span>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;

            reportContent.innerHTML = html;
            reportSection.classList.remove('hidden');
            reportSection.scrollIntoView({ behavior: 'smooth' });
        }

        // å…³é—­æŠ¥å‘Š
        function closeReport() {
            document.getElementById('reportSection').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(element, message, type) {
            const bgColor = type === 'success' ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800';
            element.innerHTML = `
                <div class="${bgColor} border-l-4 p-3 rounded text-sm">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                if (type === 'success') {
                    element.innerHTML = '';
                }
            }, 5000);
        }

        // æ‰“å¼€Excelç¼–è¾‘å™¨
        async function openExcelEditor() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('excelEditorMonth').value = currentMonth;
            document.getElementById('excelEditorModal').classList.remove('hidden');

            // è‡ªåŠ¨åŠ è½½å½“å‰æœˆä»½æ•°æ®
            await loadExcelData();
        }

        // å…³é—­Excelç¼–è¾‘å™¨
        function closeExcelEditor() {
            document.getElementById('excelEditorModal').classList.add('hidden');
            document.getElementById('excelDataContainer').classList.add('hidden');
            document.getElementById('excelLoadingMessage').classList.remove('hidden');
        }

        // åŠ è½½Excelæ•°æ®
        async function loadExcelData() {
            const month = document.getElementById('excelEditorMonth').value;
            const btn = document.getElementById('loadExcelBtn');

            if (!month) {
                alert('è¯·é€‰æ‹©æœˆä»½');
                return;
            }

            btn.innerHTML = '<span class="loading"></span> åŠ è½½ä¸­...';

            try {
                const response = await fetch(`/api/workhours/excel/data?yearMonth=${month}`);
                const data = await response.json();

                if (data.success) {
                    displayExcelData(data.data, month);
                    document.getElementById('excelDataContainer').classList.remove('hidden');
                    document.getElementById('excelLoadingMessage').classList.add('hidden');
                } else {
                    alert(`åŠ è½½å¤±è´¥: ${data.message}`);
                }
            } catch (error) {
                alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                btn.innerHTML = 'ğŸ”„ åŠ è½½æ•°æ®';
            }
        }

        // æ˜¾ç¤ºExcelæ•°æ®
        function displayExcelData(records, yearMonth) {
            const tbody = document.getElementById('excelTableBody');
            document.getElementById('excelEditorTitle').textContent = `${yearMonth} è€ƒå‹¤æ•°æ®`;

            const today = new Date().toISOString().slice(0, 10);

            tbody.innerHTML = records.map((record, index) => {
                const isWeekend = !record.workday;
                const isToday = record.date === today;
                const rowClass = isToday ? 'bg-cyan-100' : (isWeekend ? 'bg-gray-50' : '');
                const leaveTypeValue = record.leaveType || 'NONE';

                return `
                    <tr class="${rowClass} hover:bg-blue-50 transition-colors" data-date="${record.date}" id="row-${record.date}">
                        <td class="px-4 py-3 border-b text-sm font-medium">${record.date}${isToday ? ' <span class="text-xs text-cyan-600 font-bold">ä»Šå¤©</span>' : ''}</td>
                        <td class="px-4 py-3 border-b text-sm">${record.dayOfWeek}</td>
                        <td class="px-4 py-3 border-b text-sm">
                            <input
                                type="time"
                                value="${record.startTime || ''}"
                                onchange="updateAttendance('${record.date}', 'startTime', this.value)"
                                class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                            >
                        </td>
                        <td class="px-4 py-3 border-b text-sm">
                            <input
                                type="time"
                                value="${record.endTime || ''}"
                                onchange="updateAttendance('${record.date}', 'endTime', this.value)"
                                class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                            >
                        </td>
                        <td class="px-4 py-3 border-b text-sm">
                            <select
                                onchange="updateAttendance('${record.date}', 'leaveType', this.value)"
                                class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-sm"
                            >
                                <option value="NONE" ${leaveTypeValue === 'NONE' ? 'selected' : ''}>æ­£å¸¸</option>
                                <option value="MORNING" ${leaveTypeValue === 'MORNING' ? 'selected' : ''}>ä¸Šåˆè¯·å‡</option>
                                <option value="AFTERNOON" ${leaveTypeValue === 'AFTERNOON' ? 'selected' : ''}>ä¸‹åˆè¯·å‡</option>
                                <option value="FULL_DAY" ${leaveTypeValue === 'FULL_DAY' ? 'selected' : ''}>å…¨å¤©è¯·å‡</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 border-b text-sm font-semibold text-center">${record.workHours > 0 ? record.workHours.toFixed(2) : '-'}</td>
                    </tr>
                `;
            }).join('');

            // æ»šåŠ¨åˆ°å½“å¤©çš„ä½ç½®
            setTimeout(() => {
                const todayRow = document.getElementById(`row-${today}`);
                if (todayRow) {
                    todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // æ›´æ–°è€ƒå‹¤æ•°æ®
        let updateTimeout = null;
        async function updateAttendance(date, field, value) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }

            // å»¶è¿Ÿä¿å­˜ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
            updateTimeout = setTimeout(async () => {
                try {
                    // è·å–è¯¥æ—¥æœŸè¡Œçš„æ‰€æœ‰æ•°æ®
                    const row = event.target.closest('tr');
                    const startTimeInput = row.querySelector('input[type="time"]:nth-of-type(1)');
                    const endTimeInput = row.querySelector('input[type="time"]:nth-of-type(2)');
                    const leaveTypeSelect = row.querySelector('select');

                    const requestBody = {
                        date: date,
                        startTime: startTimeInput.value || null,
                        endTime: endTimeInput.value || null,
                        leaveType: leaveTypeSelect.value,
                        remark: null
                    };

                    const response = await fetch('/api/workhours/attendance/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();

                    if (data.success) {
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        row.classList.add('bg-green-50');
                        setTimeout(() => {
                            row.classList.remove('bg-green-50');
                        }, 1000);
                    } else {
                        alert(`ä¿å­˜å¤±è´¥: ${data.message}`);
                    }
                } catch (error) {
                    alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
                }
            }, 500); // 500msåä¿å­˜
        }

    </script>
</body>
</html>
